#!/usr/bin/env bash
#
# ğŸ”§ Git Pre-Commit Hook for LearningLab
#   - KÃ¸rer kodeformatering (Black/Prettier)
#   - KÃ¸rer linte-checks (flake8, ESLint)
#   - KÃ¸rer unit tests (om muligt)
#   - Genindekserer RAG (index_code_chunks.py)
#   - Forhindrer commit hvis alvorlige fejl
#

# ----------------------------------------
# Funktioner
# ----------------------------------------

# Udskrivning af farver
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Skift til projektens rod
PROJECT_ROOT=$(git rev-parse --show-toplevel)
cd "$PROJECT_ROOT" || exit 1

echo -e "${YELLOW}ğŸ” KÃ¸rer Git pre-commit checks...${NC}"

# 1) KÃ¸r Python-format (Black) og -lint (flake8)
if command -v black >/dev/null 2>&1; then
  echo -e "${GREEN}ğŸª„ Formaterer Python-kode med Black...${NC}"
  black --quiet .
else
  echo -e "${YELLOW}âš ï¸ Black ikke installeret â€“ springer format over${NC}"
fi

if command -v flake8 >/dev/null 2>&1; then
  echo -e "${GREEN}ğŸ” KÃ¸rer flake8 (Python lint)...${NC}"
  flake8 .
  if [ $? -ne 0 ]; then
    echo -e "${RED}âŒ flake8 fandt problemer. Fix inden commit!${NC}"
    exit 1
  fi
else
  echo -e "${YELLOW}âš ï¸ flake8 ikke installeret â€“ springer lint over${NC}"
fi

# 2) KÃ¸r JS/TS-format (Prettier) og -lint (ESLint)
if command -v npm >/dev/null 2>&1; then
  if [ -f "package.json" ]; then
    echo -e "${GREEN}ğŸ› ï¸ KÃ¸rer Prettier + ESLint for JS/TS...${NC}"
    npm run prettier -- --check . 2>/dev/null
    if [ $? -ne 0 ]; then
      echo -e "${RED}âŒ Prettier-formattingfejl. KÃ¸r 'npm run prettier -- --write .'${NC}"
      exit 1
    fi

    npm run lint 2>/dev/null
    if [ $? -ne 0 ]; then
      echo -e "${RED}âŒ ESLint fandt problemer. Fix inden commit!${NC}"
      exit 1
    fi
  fi
else
  echo -e "${YELLOW}âš ï¸ npm ikke tilgÃ¦ngeligt â€“ springer JS/TS-lint over${NC}"
fi

# 3) KÃ¸r unit tests (hvis tilgÃ¦ngelig)
if command -v pytest >/dev/null 2>&1; then
  if [ -d "tests" ]; then
    echo -e "${GREEN}ğŸ§ª KÃ¸rer Python unit tests med pytest...${NC}"
    pytest --maxfail=1 --disable-warnings -q
    if [ $? -ne 0 ]; then
      echo -e "${RED}âŒ Unit tests fejlede. Fix inden commit!${NC}"
      exit 1
    fi
  fi
fi

if command -v npm >/dev/null 2>&1; then
  if [ -f "package.json" ] && grep -q "\"test\":" package.json; then
    echo -e "${GREEN}ğŸ§ª KÃ¸rer JS/TS unit tests med npm test...${NC}"
    npm test -- --bail --silent
    if [ $? -ne 0 ]; then
      echo -e "${RED}âŒ JS/TS tests fejlede. Fix inden commit!${NC}"
      exit 1
    fi
  fi
fi

# 4) Genindeksering af RAG (ChromaDB)
echo -e "${YELLOW}ğŸ”„ Opdaterer ChromaDB RAG-indeks...${NC}"
if [ -f "scripts/index_code_chunks.py" ]; then
  python3 scripts/index_code_chunks.py
  if [ $? -eq 0 ]; then
    echo -e "${GREEN}âœ… RAG-indeks opdateret${NC}"
  else
    echo -e "${RED}âš ï¸ Fejl ved opdatering af RAG-indeks â€“ commit fortsÃ¦tter alligevel${NC}"
  fi
else
  echo -e "${YELLOW}âš ï¸ scripts/index_code_chunks.py ikke fundet â€“ springer indeksering over${NC}"
fi

# 5) TilfÃ¸j evt. andre custom checks her (f.eks. sikkerheds-scanning)

echo -e "${GREEN}ğŸ‰ Alle pre-commit checks bestÃ¥et! Du kan committe nu.${NC}"
exit 0
