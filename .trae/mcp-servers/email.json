{
  "name": "email",
  "description": "Email service integration for notifications, alerts, and communication in LearningLab platform",
  "version": "1.0.0",
  "phase": 3,
  "priority": "medium",
  "dependencies": {
    "runtime": "node",
    "packages": [
      "nodemailer",
      "@sendgrid/mail",
      "aws-sdk",
      "mailgun-js",
      "handlebars",
      "mjml"
    ],
    "system": ["node", "npm"]
  },
  "configuration": {
    "command": "node",
    "args": ["email-server.js"],
    "environment": {
      "EMAIL_PROVIDER": "${EMAIL_PROVIDER:-smtp}",
      "SMTP_HOST": "${SMTP_HOST}",
      "SMTP_PORT": "${SMTP_PORT:-587}",
      "SMTP_SECURE": "${SMTP_SECURE:-false}",
      "SMTP_USER": "${SMTP_USER}",
      "SMTP_PASS": "${SMTP_PASS}",
      "SENDGRID_API_KEY": "${SENDGRID_API_KEY}",
      "AWS_SES_REGION": "${AWS_SES_REGION:-us-east-1}",
      "AWS_ACCESS_KEY_ID": "${AWS_ACCESS_KEY_ID}",
      "AWS_SECRET_ACCESS_KEY": "${AWS_SECRET_ACCESS_KEY}",
      "MAILGUN_API_KEY": "${MAILGUN_API_KEY}",
      "MAILGUN_DOMAIN": "${MAILGUN_DOMAIN}",
      "FROM_EMAIL": "${FROM_EMAIL:-noreply@learninglab.example.com}",
      "FROM_NAME": "${FROM_NAME:-LearningLab Platform}",
      "TEMPLATE_DIR": "./templates",
      "EMAIL_QUEUE_REDIS_URL": "${REDIS_URL}",
      "MAX_SEND_RATE": "${MAX_SEND_RATE:-100}",
      "RETRY_ATTEMPTS": "${RETRY_ATTEMPTS:-3}"
    },
    "security": {
      "encryption": "tls",
      "authentication": "required",
      "rate_limiting": true,
      "spam_protection": true,
      "dkim_signing": true
    }
  },
  "providers": {
    "smtp": {
      "description": "Generic SMTP server configuration",
      "config": {
        "host": "smtp.example.com",
        "port": 587,
        "secure": false,
        "auth": {
          "user": "username",
          "pass": "password"
        },
        "tls": {
          "rejectUnauthorized": false
        }
      },
      "features": ["basic_sending", "attachments", "html_content"]
    },
    "sendgrid": {
      "description": "SendGrid email service",
      "config": {
        "api_key": "SG.xxx",
        "sandbox_mode": false
      },
      "features": [
        "transactional_emails",
        "marketing_campaigns",
        "analytics",
        "templates",
        "webhooks",
        "ip_warmup"
      ],
      "limits": {
        "free_tier": "100_emails_per_day",
        "paid_tiers": "unlimited"
      }
    },
    "aws_ses": {
      "description": "Amazon Simple Email Service",
      "config": {
        "region": "us-east-1",
        "access_key_id": "AKIA...",
        "secret_access_key": "xxx",
        "configuration_set": "learninglab-emails"
      },
      "features": [
        "high_deliverability",
        "bounce_handling",
        "complaint_handling",
        "sending_statistics",
        "reputation_tracking"
      ],
      "limits": {
        "sandbox": "200_emails_per_day",
        "production": "custom_limits"
      }
    },
    "mailgun": {
      "description": "Mailgun email service",
      "config": {
        "api_key": "key-xxx",
        "domain": "mg.learninglab.example.com",
        "host": "api.mailgun.net"
      },
      "features": [
        "email_validation",
        "detailed_analytics",
        "webhooks",
        "mailing_lists",
        "a_b_testing"
      ],
      "limits": {
        "free_tier": "5000_emails_per_month",
        "paid_tiers": "custom_limits"
      }
    },
    "gmail": {
      "description": "Gmail SMTP for development",
      "config": {
        "host": "smtp.gmail.com",
        "port": 587,
        "secure": false,
        "auth": {
          "user": "your-email@gmail.com",
          "pass": "app-password"
        }
      },
      "features": ["development_testing", "small_volume"],
      "limits": {
        "daily_limit": "500_emails"
      },
      "note": "Requires app-specific password"
    }
  },
  "email_types": {
    "system_notifications": {
      "description": "System-generated notifications and alerts",
      "templates": [
        {
          "name": "system_alert",
          "subject": "[LearningLab] System Alert: {{alert_type}}",
          "template_file": "system-alert.mjml",
          "variables": ["alert_type", "message", "timestamp", "severity"]
        },
        {
          "name": "backup_notification",
          "subject": "[LearningLab] Backup {{status}}",
          "template_file": "backup-notification.mjml",
          "variables": ["status", "backup_type", "timestamp", "size"]
        },
        {
          "name": "deployment_notification",
          "subject": "[LearningLab] Deployment {{status}} - {{environment}}",
          "template_file": "deployment-notification.mjml",
          "variables": ["status", "environment", "version", "timestamp"]
        }
      ],
      "recipients": ["admin@learninglab.example.com", "devops@learninglab.example.com"]
    },
    "user_notifications": {
      "description": "User-facing notifications and communications",
      "templates": [
        {
          "name": "welcome_email",
          "subject": "Welcome to LearningLab, {{user_name}}!",
          "template_file": "welcome-email.mjml",
          "variables": ["user_name", "login_url", "support_email"]
        },
        {
          "name": "password_reset",
          "subject": "Reset Your LearningLab Password",
          "template_file": "password-reset.mjml",
          "variables": ["user_name", "reset_link", "expiry_time"]
        },
        {
          "name": "course_completion",
          "subject": "Congratulations! You've completed {{course_name}}",
          "template_file": "course-completion.mjml",
          "variables": ["user_name", "course_name", "completion_date", "certificate_link"]
        },
        {
          "name": "assignment_reminder",
          "subject": "Reminder: {{assignment_name}} due soon",
          "template_file": "assignment-reminder.mjml",
          "variables": ["user_name", "assignment_name", "due_date", "course_name"]
        },
        {
          "name": "grade_notification",
          "subject": "New Grade Available for {{assignment_name}}",
          "template_file": "grade-notification.mjml",
          "variables": ["user_name", "assignment_name", "grade", "feedback", "course_name"]
        }
      ]
    },
    "marketing_communications": {
      "description": "Marketing and promotional emails",
      "templates": [
        {
          "name": "newsletter",
          "subject": "LearningLab Newsletter - {{month}} {{year}}",
          "template_file": "newsletter.mjml",
          "variables": ["month", "year", "featured_courses", "user_stats"]
        },
        {
          "name": "course_announcement",
          "subject": "New Course Available: {{course_name}}",
          "template_file": "course-announcement.mjml",
          "variables": ["course_name", "instructor", "start_date", "enrollment_link"]
        },
        {
          "name": "feature_update",
          "subject": "Exciting New Features in LearningLab!",
          "template_file": "feature-update.mjml",
          "variables": ["features_list", "release_date", "documentation_link"]
        }
      ],
      "compliance": {
        "gdpr_compliant": true,
        "unsubscribe_link": true,
        "consent_tracking": true
      }
    },
    "ai_generated_content": {
      "description": "AI-generated personalized emails",
      "templates": [
        {
          "name": "personalized_learning_path",
          "subject": "Your Personalized Learning Recommendations",
          "template_file": "ai-learning-recommendations.mjml",
          "ai_variables": ["recommended_courses", "learning_style", "progress_analysis"],
          "generation_prompt": "Generate personalized course recommendations based on user's learning history and preferences"
        },
        {
          "name": "adaptive_feedback",
          "subject": "Your Learning Progress Update",
          "template_file": "ai-adaptive-feedback.mjml",
          "ai_variables": ["strengths", "improvement_areas", "next_steps"],
          "generation_prompt": "Analyze user's performance and provide constructive feedback and suggestions"
        }
      ]
    }
  },
  "template_engine": {
    "mjml": {
      "description": "MJML for responsive email templates",
      "features": [
        "responsive_design",
        "cross_client_compatibility",
        "component_based",
        "easy_maintenance"
      ],
      "components": [
        "mj-body", "mj-section", "mj-column", "mj-text",
        "mj-button", "mj-image", "mj-table", "mj-social"
      ]
    },
    "handlebars": {
      "description": "Handlebars for template logic",
      "features": [
        "variable_substitution",
        "conditional_logic",
        "loops_and_iterations",
        "helper_functions"
      ],
      "helpers": [
        "formatDate", "formatCurrency", "capitalize",
        "truncate", "ifEquals", "math"
      ]
    }
  },
  "use_cases": {
    "phase_3_1_notification_system": {
      "description": "Implement comprehensive notification system",
      "workflow": [
        {
          "step": "setup_email_service",
          "operations": ["configureProvider", "setupTemplates", "testDelivery"],
          "resources": ["email-config", "template-files", "test-emails"]
        },
        {
          "step": "integrate_with_application",
          "operations": ["addEmailTriggers", "configureQueues", "setupWebhooks"],
          "resources": ["event-handlers", "queue-system", "webhook-endpoints"]
        },
        {
          "step": "implement_user_preferences",
          "operations": ["createPreferencesUI", "setupSubscriptions", "handleUnsubscribes"],
          "resources": ["preferences-page", "subscription-management", "unsubscribe-handler"]
        },
        {
          "step": "monitor_and_optimize",
          "operations": ["trackDeliveryRates", "analyzeEngagement", "optimizeTemplates"],
          "resources": ["analytics-dashboard", "engagement-metrics", "a-b-tests"]
        }
      ]
    },
    "automated_communications": {
      "description": "Automated email workflows for user engagement",
      "workflows": [
        {
          "name": "user_onboarding",
          "trigger": "user_registration",
          "emails": [
            {"delay": "0", "template": "welcome_email"},
            {"delay": "1d", "template": "getting_started_guide"},
            {"delay": "3d", "template": "first_course_recommendation"},
            {"delay": "7d", "template": "onboarding_survey"}
          ]
        },
        {
          "name": "course_engagement",
          "trigger": "course_enrollment",
          "emails": [
            {"delay": "0", "template": "enrollment_confirmation"},
            {"delay": "1d", "template": "course_start_reminder"},
            {"delay": "7d", "template": "progress_check", "condition": "progress < 25%"},
            {"delay": "14d", "template": "motivation_email", "condition": "progress < 50%"}
          ]
        },
        {
          "name": "re_engagement",
          "trigger": "user_inactive_30_days",
          "emails": [
            {"delay": "0", "template": "we_miss_you"},
            {"delay": "7d", "template": "special_offer"},
            {"delay": "14d", "template": "final_reminder"}
          ]
        }
      ]
    },
    "ai_powered_personalization": {
      "description": "AI-driven personalized email content",
      "features": [
        {
          "name": "content_personalization",
          "description": "Personalize email content based on user behavior",
          "ai_model": "gpt-4",
          "inputs": ["user_profile", "learning_history", "preferences"],
          "outputs": ["personalized_subject", "customized_content", "recommendations"]
        },
        {
          "name": "send_time_optimization",
          "description": "Optimize email send times for each user",
          "ai_model": "time_series_analysis",
          "inputs": ["user_timezone", "engagement_history", "open_patterns"],
          "outputs": ["optimal_send_time", "day_of_week", "frequency"]
        },
        {
          "name": "subject_line_optimization",
          "description": "Generate and test optimal subject lines",
          "ai_model": "nlp_optimization",
          "inputs": ["email_content", "user_segment", "historical_performance"],
          "outputs": ["optimized_subject", "a_b_variants", "predicted_open_rate"]
        }
      ]
    }
  },
  "queue_management": {
    "redis_queue": {
      "description": "Redis-based email queue for reliable delivery",
      "features": [
        "job_scheduling",
        "retry_logic",
        "priority_queues",
        "dead_letter_queue",
        "rate_limiting"
      ],
      "configuration": {
        "default_queue": "emails",
        "priority_queue": "urgent_emails",
        "retry_attempts": 3,
        "retry_delay": "exponential_backoff",
        "max_concurrent_jobs": 10
      }
    },
    "job_types": {
      "immediate": {
        "description": "Send immediately (password resets, alerts)",
        "priority": "high",
        "max_delay": "30s"
      },
      "scheduled": {
        "description": "Send at specific time (newsletters, announcements)",
        "priority": "medium",
        "scheduling": "cron_expression"
      },
      "bulk": {
        "description": "Bulk emails (marketing campaigns)",
        "priority": "low",
        "rate_limit": "100_per_hour"
      }
    }
  },
  "analytics_tracking": {
    "email_metrics": {
      "delivery_metrics": [
        "sent_count",
        "delivered_count",
        "bounce_rate",
        "delivery_rate"
      ],
      "engagement_metrics": [
        "open_rate",
        "click_rate",
        "unsubscribe_rate",
        "spam_complaint_rate"
      ],
      "conversion_metrics": [
        "conversion_rate",
        "revenue_per_email",
        "goal_completion_rate"
      ]
    },
    "tracking_implementation": {
      "open_tracking": {
        "method": "pixel_tracking",
        "privacy_compliant": true
      },
      "click_tracking": {
        "method": "redirect_urls",
        "utm_parameters": true
      },
      "unsubscribe_tracking": {
        "one_click_unsubscribe": true,
        "preference_center": true
      }
    },
    "reporting": {
      "real_time_dashboard": true,
      "automated_reports": {
        "daily_summary": true,
        "weekly_analysis": true,
        "monthly_trends": true
      },
      "export_formats": ["csv", "json", "pdf"]
    }
  },
  "compliance_privacy": {
    "gdpr_compliance": {
      "consent_management": true,
      "data_portability": true,
      "right_to_erasure": true,
      "privacy_by_design": true
    },
    "can_spam_compliance": {
      "clear_sender_identification": true,
      "truthful_subject_lines": true,
      "clear_unsubscribe_mechanism": true,
      "physical_address_required": true
    },
    "data_retention": {
      "email_logs": "2_years",
      "engagement_data": "3_years",
      "unsubscribe_records": "permanent",
      "bounce_data": "1_year"
    }
  },
  "monitoring": {
    "health_check": {
      "command": "curl -f http://localhost:3000/health || exit 1",
      "interval": 30,
      "timeout": 10
    },
    "metrics": {
      "email_queue_size": "Number of emails in queue",
      "email_send_rate": "Emails sent per minute",
      "email_delivery_rate": "Percentage of emails delivered",
      "email_bounce_rate": "Percentage of emails bounced",
      "email_open_rate": "Percentage of emails opened",
      "email_click_rate": "Percentage of emails clicked",
      "email_processing_time": "Time to process email queue",
      "email_template_render_time": "Time to render email templates"
    },
    "alerts": {
      "high_bounce_rate": {
        "condition": "bounce_rate > 5%",
        "severity": "warning",
        "notification": ["email", "slack"]
      },
      "queue_backup": {
        "condition": "queue_size > 1000",
        "severity": "critical",
        "notification": ["email", "slack", "pagerduty"]
      },
      "delivery_failure": {
        "condition": "delivery_rate < 95%",
        "severity": "high",
        "notification": ["email", "slack"]
      }
    }
  },
  "testing": {
    "unit_tests": [
      {
        "name": "test_email_template_rendering",
        "description": "Test email template compilation and rendering",
        "test_cases": [
          "valid_template_with_variables",
          "template_with_missing_variables",
          "template_with_conditional_logic",
          "template_with_loops"
        ]
      },
      {
        "name": "test_email_queue_operations",
        "description": "Test email queue functionality",
        "test_cases": [
          "add_email_to_queue",
          "process_email_queue",
          "handle_failed_emails",
          "retry_mechanism"
        ]
      }
    ],
    "integration_tests": [
      {
        "name": "test_email_provider_integration",
        "description": "Test integration with email providers",
        "providers": ["smtp", "sendgrid", "aws_ses", "mailgun"],
        "test_scenarios": [
          "successful_email_delivery",
          "handle_provider_errors",
          "authentication_failure",
          "rate_limit_handling"
        ]
      },
      {
        "name": "test_webhook_handling",
        "description": "Test webhook processing for delivery events",
        "events": ["delivered", "opened", "clicked", "bounced", "complained"]
      }
    ],
    "load_tests": [
      {
        "name": "test_bulk_email_sending",
        "description": "Test system performance with bulk email sending",
        "scenarios": [
          {"emails": 1000, "duration": "5m"},
          {"emails": 10000, "duration": "30m"},
          {"emails": 100000, "duration": "2h"}
        ]
      }
    ]
  },
  "best_practices": {
    "deliverability": [
      "Maintain good sender reputation",
      "Use proper SPF, DKIM, and DMARC records",
      "Monitor bounce and complaint rates",
      "Implement proper list hygiene",
      "Use double opt-in for subscriptions"
    ],
    "content": [
      "Write compelling subject lines",
      "Use responsive email templates",
      "Include clear call-to-action buttons",
      "Optimize for mobile devices",
      "Test across different email clients"
    ],
    "performance": [
      "Use email queues for bulk sending",
      "Implement proper retry mechanisms",
      "Monitor and optimize send times",
      "Use CDN for email images",
      "Implement email caching where appropriate"
    ],
    "security": [
      "Encrypt sensitive data in emails",
      "Use secure authentication methods",
      "Implement rate limiting",
      "Validate email addresses",
      "Monitor for suspicious activities"
    ]
  }
}