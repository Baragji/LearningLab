{
  "name": "grafana",
  "description": "Grafana monitoring and analytics dashboards for LearningLab platform",
  "version": "1.0.0",
  "phase": 3,
  "priority": "medium",
  "dependencies": {
    "runtime": "docker",
    "images": [
      "grafana/grafana:latest",
      "prom/prometheus:latest",
      "prom/node-exporter:latest"
    ],
    "system": ["docker", "docker-compose"]
  },
  "configuration": {
    "command": "docker-compose",
    "args": ["-f", "./docker/monitoring/docker-compose.yml", "up", "-d"],
    "environment": {
      "GRAFANA_PORT": "3000",
      "GRAFANA_ADMIN_USER": "admin",
      "GRAFANA_ADMIN_PASSWORD": "${GRAFANA_ADMIN_PASSWORD}",
      "PROMETHEUS_PORT": "9090",
      "NODE_EXPORTER_PORT": "9100",
      "GRAFANA_DATA_DIR": "./data/grafana",
      "PROMETHEUS_DATA_DIR": "./data/prometheus",
      "GRAFANA_PLUGINS": "grafana-clock-panel,grafana-simple-json-datasource,grafana-worldmap-panel"
    },
    "security": {
      "authentication": "required",
      "ssl_enabled": true,
      "allowed_origins": ["http://localhost:3000", "https://learninglab.local"],
      "session_timeout": "24h",
      "password_policy": "strong"
    }
  },
  "dashboards": {
    "system_overview": {
      "file": "./grafana/dashboards/system-overview.json",
      "description": "Overall system health and performance metrics",
      "panels": [
        {
          "title": "System Health",
          "type": "stat",
          "metrics": ["cpu_usage", "memory_usage", "disk_usage"],
          "thresholds": {"warning": 70, "critical": 90}
        },
        {
          "title": "Request Rate",
          "type": "graph",
          "metrics": ["http_requests_per_second"],
          "time_range": "1h"
        },
        {
          "title": "Response Times",
          "type": "heatmap",
          "metrics": ["http_request_duration_seconds"],
          "buckets": [0.1, 0.5, 1.0, 2.0, 5.0]
        },
        {
          "title": "Error Rate",
          "type": "graph",
          "metrics": ["http_errors_per_second"],
          "alert_threshold": 5
        }
      ]
    },
    "learning_analytics": {
      "file": "./grafana/dashboards/learning-analytics.json",
      "description": "Educational metrics and learning analytics",
      "panels": [
        {
          "title": "Active Users",
          "type": "stat",
          "metrics": ["active_users_total", "new_users_today"],
          "time_range": "24h"
        },
        {
          "title": "Course Engagement",
          "type": "bar_gauge",
          "metrics": ["course_completion_rate", "lesson_engagement_rate"],
          "grouping": "by_course"
        },
        {
          "title": "Quiz Performance",
          "type": "graph",
          "metrics": ["quiz_average_score", "quiz_completion_rate"],
          "time_range": "7d"
        },
        {
          "title": "Learning Progress",
          "type": "heatmap",
          "metrics": ["student_progress_distribution"],
          "dimensions": ["course", "week"]
        },
        {
          "title": "AI Usage",
          "type": "graph",
          "metrics": ["ai_content_analysis_requests", "ai_feedback_generations"],
          "time_range": "24h"
        }
      ]
    },
    "user_behavior": {
      "file": "./grafana/dashboards/user-behavior.json",
      "description": "User interaction and behavior analytics",
      "panels": [
        {
          "title": "Session Duration",
          "type": "histogram",
          "metrics": ["session_duration_minutes"],
          "buckets": [5, 15, 30, 60, 120]
        },
        {
          "title": "Page Views",
          "type": "table",
          "metrics": ["page_views_by_path"],
          "columns": ["path", "views", "unique_users", "avg_time"]
        },
        {
          "title": "Feature Usage",
          "type": "pie",
          "metrics": ["feature_usage_distribution"],
          "features": ["quiz_taking", "content_viewing", "discussion", "ai_help"]
        },
        {
          "title": "User Journey",
          "type": "sankey",
          "metrics": ["user_flow_paths"],
          "max_steps": 5
        }
      ]
    },
    "ai_services": {
      "file": "./grafana/dashboards/ai-services.json",
      "description": "AI services performance and usage metrics",
      "panels": [
        {
          "title": "AI API Calls",
          "type": "graph",
          "metrics": ["ai_api_calls_per_minute"],
          "breakdown": ["service", "model"]
        },
        {
          "title": "AI Response Times",
          "type": "heatmap",
          "metrics": ["ai_response_duration_seconds"],
          "services": ["openai", "anthropic", "local_models"]
        },
        {
          "title": "AI Costs",
          "type": "stat",
          "metrics": ["ai_cost_today", "ai_cost_month"],
          "currency": "USD"
        },
        {
          "title": "Content Analysis Quality",
          "type": "gauge",
          "metrics": ["content_analysis_accuracy", "quiz_generation_quality"],
          "range": [0, 100]
        },
        {
          "title": "AI Error Rate",
          "type": "graph",
          "metrics": ["ai_errors_per_hour"],
          "alert_threshold": 10
        }
      ]
    },
    "performance_monitoring": {
      "file": "./grafana/dashboards/performance-monitoring.json",
      "description": "Application performance and infrastructure metrics",
      "panels": [
        {
          "title": "Database Performance",
          "type": "graph",
          "metrics": ["db_query_duration", "db_connections_active"],
          "databases": ["postgresql", "redis"]
        },
        {
          "title": "Cache Hit Rate",
          "type": "stat",
          "metrics": ["cache_hit_rate_percent"],
          "target": 95
        },
        {
          "title": "File Upload Performance",
          "type": "graph",
          "metrics": ["file_upload_duration", "file_processing_time"],
          "file_types": ["pdf", "video", "image"]
        },
        {
          "title": "Background Jobs",
          "type": "table",
          "metrics": ["job_queue_status"],
          "columns": ["queue", "pending", "processing", "failed"]
        }
      ]
    },
    "security_monitoring": {
      "file": "./grafana/dashboards/security-monitoring.json",
      "description": "Security events and threat monitoring",
      "panels": [
        {
          "title": "Failed Login Attempts",
          "type": "graph",
          "metrics": ["failed_login_attempts_per_hour"],
          "alert_threshold": 50
        },
        {
          "title": "Suspicious Activity",
          "type": "table",
          "metrics": ["security_events"],
          "columns": ["timestamp", "event_type", "user", "ip_address", "severity"]
        },
        {
          "title": "Rate Limiting",
          "type": "graph",
          "metrics": ["rate_limit_violations"],
          "breakdown": ["endpoint", "user"]
        },
        {
          "title": "SSL Certificate Status",
          "type": "stat",
          "metrics": ["ssl_cert_expiry_days"],
          "warning_threshold": 30
        }
      ]
    }
  },
  "data_sources": {
    "prometheus": {
      "type": "prometheus",
      "url": "http://prometheus:9090",
      "access": "proxy",
      "is_default": true,
      "scrape_configs": [
        {
          "job_name": "learninglab-app",
          "static_configs": [{"targets": ["app:3000"]}],
          "metrics_path": "/metrics",
          "scrape_interval": "15s"
        },
        {
          "job_name": "learninglab-api",
          "static_configs": [{"targets": ["api:8000"]}],
          "metrics_path": "/api/metrics",
          "scrape_interval": "15s"
        },
        {
          "job_name": "postgresql",
          "static_configs": [{"targets": ["postgres-exporter:9187"]}],
          "scrape_interval": "30s"
        },
        {
          "job_name": "redis",
          "static_configs": [{"targets": ["redis-exporter:9121"]}],
          "scrape_interval": "30s"
        }
      ]
    },
    "loki": {
      "type": "loki",
      "url": "http://loki:3100",
      "access": "proxy",
      "log_sources": [
        "application_logs",
        "access_logs",
        "error_logs",
        "audit_logs"
      ]
    },
    "elasticsearch": {
      "type": "elasticsearch",
      "url": "http://elasticsearch:9200",
      "access": "proxy",
      "indices": [
        "learninglab-logs-*",
        "learninglab-metrics-*",
        "learninglab-events-*"
      ]
    },
    "postgresql": {
      "type": "postgres",
      "host": "postgresql:5432",
      "database": "learninglab",
      "user": "${DB_USER}",
      "password": "${DB_PASSWORD}",
      "ssl_mode": "require"
    }
  },
  "alerts": {
    "system_alerts": [
      {
        "name": "High CPU Usage",
        "condition": "avg(cpu_usage_percent) > 80",
        "duration": "5m",
        "severity": "warning",
        "notifications": ["email", "slack"]
      },
      {
        "name": "High Memory Usage",
        "condition": "avg(memory_usage_percent) > 85",
        "duration": "5m",
        "severity": "warning",
        "notifications": ["email", "slack"]
      },
      {
        "name": "Disk Space Low",
        "condition": "avg(disk_usage_percent) > 90",
        "duration": "1m",
        "severity": "critical",
        "notifications": ["email", "slack", "pagerduty"]
      }
    ],
    "application_alerts": [
      {
        "name": "High Error Rate",
        "condition": "rate(http_errors_total[5m]) > 0.05",
        "duration": "2m",
        "severity": "critical",
        "notifications": ["email", "slack"]
      },
      {
        "name": "Slow Response Times",
        "condition": "avg(http_request_duration_seconds) > 2",
        "duration": "5m",
        "severity": "warning",
        "notifications": ["slack"]
      },
      {
        "name": "Database Connection Issues",
        "condition": "avg(db_connections_failed) > 5",
        "duration": "1m",
        "severity": "critical",
        "notifications": ["email", "slack", "pagerduty"]
      }
    ],
    "business_alerts": [
      {
        "name": "Low User Engagement",
        "condition": "avg(daily_active_users) < 100",
        "duration": "1d",
        "severity": "warning",
        "notifications": ["email"]
      },
      {
        "name": "High AI Costs",
        "condition": "sum(ai_cost_daily) > 500",
        "duration": "1h",
        "severity": "warning",
        "notifications": ["email", "slack"]
      },
      {
        "name": "Quiz Completion Rate Drop",
        "condition": "avg(quiz_completion_rate) < 0.6",
        "duration": "6h",
        "severity": "warning",
        "notifications": ["email"]
      }
    ]
  },
  "use_cases": {
    "phase_3_1_gamification_analytics": {
      "description": "Monitor gamification features and user engagement",
      "metrics": [
        "badge_earned_events",
        "leaderboard_interactions",
        "achievement_completion_rate",
        "point_distribution",
        "streak_maintenance_rate"
      ],
      "dashboards": ["gamification_overview", "user_engagement"],
      "alerts": [
        "low_badge_earning_rate",
        "leaderboard_inactivity",
        "achievement_system_errors"
      ]
    },
    "phase_3_2_advanced_analytics": {
      "description": "Advanced learning analytics and insights",
      "metrics": [
        "learning_path_effectiveness",
        "content_difficulty_accuracy",
        "personalization_success_rate",
        "adaptive_algorithm_performance",
        "knowledge_retention_rates"
      ],
      "dashboards": ["learning_analytics", "ai_services"],
      "alerts": [
        "poor_personalization_performance",
        "adaptive_algorithm_failures",
        "content_quality_degradation"
      ]
    },
    "real_time_monitoring": {
      "description": "Real-time system and application monitoring",
      "refresh_interval": "5s",
      "auto_refresh": true,
      "panels": [
        "live_user_count",
        "current_system_load",
        "active_sessions",
        "real_time_errors"
      ]
    }
  },
  "monitoring": {
    "health_check": {
      "command": "curl -f http://localhost:3000/api/health",
      "interval": 30,
      "timeout": 10
    },
    "metrics": {
      "grafana_dashboard_views": "Counter of dashboard views",
      "grafana_alert_notifications": "Counter of alert notifications sent",
      "grafana_query_duration": "Histogram of query execution times",
      "grafana_active_sessions": "Gauge of active user sessions"
    },
    "self_monitoring": {
      "prometheus_targets_up": "Monitor Prometheus target health",
      "grafana_datasource_health": "Monitor data source connectivity",
      "alert_manager_status": "Monitor alert manager functionality"
    }
  },
  "integration": {
    "notification_channels": {
      "email": {
        "type": "email",
        "settings": {
          "addresses": "${ALERT_EMAIL_ADDRESSES}",
          "subject": "LearningLab Alert: {{ .CommonLabels.alertname }}"
        }
      },
      "slack": {
        "type": "slack",
        "settings": {
          "url": "${SLACK_WEBHOOK_URL}",
          "channel": "#learninglab-alerts",
          "username": "Grafana"
        }
      },
      "pagerduty": {
        "type": "pagerduty",
        "settings": {
          "integration_key": "${PAGERDUTY_INTEGRATION_KEY}",
          "severity": "critical"
        }
      }
    },
    "external_systems": {
      "learning_management_system": {
        "webhook_url": "${LMS_WEBHOOK_URL}",
        "events": ["course_completion", "quiz_failure", "engagement_drop"]
      },
      "student_information_system": {
        "api_endpoint": "${SIS_API_ENDPOINT}",
        "sync_interval": "1h",
        "data_types": ["enrollment", "grades", "attendance"]
      }
    }
  },
  "backup_and_recovery": {
    "dashboard_backup": {
      "schedule": "daily",
      "retention": "30d",
      "location": "./backups/grafana-dashboards"
    },
    "data_source_config_backup": {
      "schedule": "weekly",
      "retention": "12w",
      "location": "./backups/grafana-config"
    },
    "recovery_procedures": [
      "Restore from backup files",
      "Reconfigure data sources",
      "Import dashboard definitions",
      "Verify alert configurations"
    ]
  },
  "testing": {
    "dashboard_tests": [
      {
        "name": "test_dashboard_loading",
        "description": "Test that all dashboards load without errors",
        "dashboards": ["system_overview", "learning_analytics", "user_behavior"]
      },
      {
        "name": "test_data_source_connectivity",
        "description": "Test connectivity to all data sources",
        "data_sources": ["prometheus", "loki", "postgresql"]
      }
    ],
    "alert_tests": [
      {
        "name": "test_alert_firing",
        "description": "Test that alerts fire correctly",
        "test_conditions": ["high_cpu", "high_error_rate", "disk_space_low"]
      },
      {
        "name": "test_notification_delivery",
        "description": "Test alert notification delivery",
        "channels": ["email", "slack"]
      }
    ]
  },
  "best_practices": {
    "dashboard_design": [
      "Use consistent color schemes across dashboards",
      "Implement proper time range controls",
      "Add meaningful descriptions to panels",
      "Use appropriate visualization types for data",
      "Organize panels logically and hierarchically"
    ],
    "alerting": [
      "Set appropriate thresholds to avoid alert fatigue",
      "Use different severity levels effectively",
      "Include context in alert messages",
      "Test alerts regularly",
      "Document alert response procedures"
    ],
    "performance": [
      "Optimize queries for better performance",
      "Use appropriate time ranges for queries",
      "Implement caching where possible",
      "Monitor Grafana resource usage",
      "Regular cleanup of old data"
    ],
    "security": [
      "Use strong authentication mechanisms",
      "Implement role-based access control",
      "Secure data source connections",
      "Regular security updates",
      "Audit user access and permissions"
    ]
  }
}